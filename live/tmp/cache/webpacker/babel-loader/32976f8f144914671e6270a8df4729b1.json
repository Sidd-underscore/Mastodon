{"ast":null,"code":"var _jsxFileName = \"/home/runner/Mastodon/live/app/javascript/mastodon/features/ui/components/zoomable_image.js\",\n    _class,\n    _class2,\n    _temp;\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; _setPrototypeOf(subClass, superClass); }\n\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport IconButton from 'mastodon/components/icon_button';\nimport { defineMessages, injectIntl } from 'react-intl';\nvar messages = defineMessages({\n  compress: {\n    \"id\": \"lightbox.compress\",\n    \"defaultMessage\": \"Compress image view box\"\n  },\n  expand: {\n    \"id\": \"lightbox.expand\",\n    \"defaultMessage\": \"Expand image view box\"\n  }\n});\nvar MIN_SCALE = 1;\nvar MAX_SCALE = 4;\nvar NAV_BAR_HEIGHT = 66;\n\nvar getMidpoint = function getMidpoint(p1, p2) {\n  return {\n    x: (p1.clientX + p2.clientX) / 2,\n    y: (p1.clientY + p2.clientY) / 2\n  };\n};\n\nvar getDistance = function getDistance(p1, p2) {\n  return Math.sqrt(Math.pow(p1.clientX - p2.clientX, 2) + Math.pow(p1.clientY - p2.clientY, 2));\n};\n\nvar clamp = function clamp(min, max, value) {\n  return Math.min(max, Math.max(min, value));\n}; // Normalizing mousewheel speed across browsers\n// copy from: https://github.com/facebookarchive/fixed-data-table/blob/master/src/vendor_upstream/dom/normalizeWheel.js\n\n\nvar normalizeWheel = function normalizeWheel(event) {\n  // Reasonable defaults\n  var PIXEL_STEP = 10;\n  var LINE_HEIGHT = 40;\n  var PAGE_HEIGHT = 800;\n  var sX = 0,\n      sY = 0,\n      // spinX, spinY\n  pX = 0,\n      pY = 0; // pixelX, pixelY\n  // Legacy\n\n  if ('detail' in event) {\n    sY = event.detail;\n  }\n\n  if ('wheelDelta' in event) {\n    sY = -event.wheelDelta / 120;\n  }\n\n  if ('wheelDeltaY' in event) {\n    sY = -event.wheelDeltaY / 120;\n  }\n\n  if ('wheelDeltaX' in event) {\n    sX = -event.wheelDeltaX / 120;\n  } // side scrolling on FF with DOMMouseScroll\n\n\n  if ('axis' in event && event.axis === event.HORIZONTAL_AXIS) {\n    sX = sY;\n    sY = 0;\n  }\n\n  pX = sX * PIXEL_STEP;\n  pY = sY * PIXEL_STEP;\n\n  if ('deltaY' in event) {\n    pY = event.deltaY;\n  }\n\n  if ('deltaX' in event) {\n    pX = event.deltaX;\n  }\n\n  if ((pX || pY) && event.deltaMode) {\n    if (event.deltaMode === 1) {\n      // delta in LINE units\n      pX *= LINE_HEIGHT;\n      pY *= LINE_HEIGHT;\n    } else {\n      // delta in PAGE units\n      pX *= PAGE_HEIGHT;\n      pY *= PAGE_HEIGHT;\n    }\n  } // Fall-back if spin cannot be determined\n\n\n  if (pX && !sX) {\n    sX = pX < 1 ? -1 : 1;\n  }\n\n  if (pY && !sY) {\n    sY = pY < 1 ? -1 : 1;\n  }\n\n  return {\n    spinX: sX,\n    spinY: sY,\n    pixelX: pX,\n    pixelY: pY\n  };\n};\n\nvar ZoomableImage = injectIntl(_class = (_temp = _class2 = /*#__PURE__*/function (_React$PureComponent) {\n  _inheritsLoose(ZoomableImage, _React$PureComponent);\n\n  function ZoomableImage() {\n    var _this;\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _React$PureComponent.call.apply(_React$PureComponent, [this].concat(args)) || this;\n    _this.state = {\n      scale: MIN_SCALE,\n      zoomMatrix: {\n        type: null,\n        // 'width' 'height'\n        fullScreen: null,\n        // bool\n        rate: null,\n        // full screen scale rate\n        clientWidth: null,\n        clientHeight: null,\n        offsetWidth: null,\n        offsetHeight: null,\n        clientHeightFixed: null,\n        scrollTop: null,\n        scrollLeft: null,\n        translateX: null,\n        translateY: null\n      },\n      zoomState: 'expand',\n      // 'expand' 'compress'\n      navigationHidden: false,\n      dragPosition: {\n        top: 0,\n        left: 0,\n        x: 0,\n        y: 0\n      },\n      dragged: false,\n      lockScroll: {\n        x: 0,\n        y: 0\n      },\n      lockTranslate: {\n        x: 0,\n        y: 0\n      }\n    };\n    _this.removers = [];\n    _this.container = null;\n    _this.image = null;\n    _this.lastTouchEndTime = 0;\n    _this.lastDistance = 0;\n\n    _this.mouseWheelHandler = function (e) {\n      e.preventDefault();\n      var event = normalizeWheel(e);\n\n      if (_this.state.zoomMatrix.type === 'width') {\n        // full width, scroll vertical\n        _this.container.scrollTop = Math.max(_this.container.scrollTop + event.pixelY, _this.state.lockScroll.y);\n      } else {\n        // full height, scroll horizontal\n        _this.container.scrollLeft = Math.max(_this.container.scrollLeft + event.pixelY, _this.state.lockScroll.x);\n      } // lock horizontal scroll\n\n\n      _this.container.scrollLeft = Math.max(_this.container.scrollLeft + event.pixelX, _this.state.lockScroll.x);\n    };\n\n    _this.mouseDownHandler = function (e) {\n      _this.container.style.cursor = 'grabbing';\n      _this.container.style.userSelect = 'none';\n\n      _this.setState({\n        dragPosition: {\n          left: _this.container.scrollLeft,\n          top: _this.container.scrollTop,\n          // Get the current mouse position\n          x: e.clientX,\n          y: e.clientY\n        }\n      });\n\n      _this.image.addEventListener('mousemove', _this.mouseMoveHandler);\n\n      _this.image.addEventListener('mouseup', _this.mouseUpHandler);\n    };\n\n    _this.mouseMoveHandler = function (e) {\n      var dx = e.clientX - _this.state.dragPosition.x;\n      var dy = e.clientY - _this.state.dragPosition.y;\n      _this.container.scrollLeft = Math.max(_this.state.dragPosition.left - dx, _this.state.lockScroll.x);\n      _this.container.scrollTop = Math.max(_this.state.dragPosition.top - dy, _this.state.lockScroll.y);\n\n      _this.setState({\n        dragged: true\n      });\n    };\n\n    _this.mouseUpHandler = function () {\n      _this.container.style.cursor = 'grab';\n\n      _this.container.style.removeProperty('user-select');\n\n      _this.image.removeEventListener('mousemove', _this.mouseMoveHandler);\n\n      _this.image.removeEventListener('mouseup', _this.mouseUpHandler);\n    };\n\n    _this.handleTouchStart = function (e) {\n      if (e.touches.length !== 2) return;\n      _this.lastDistance = getDistance.apply(void 0, e.touches);\n    };\n\n    _this.handleTouchMove = function (e) {\n      var _this$container = _this.container,\n          scrollTop = _this$container.scrollTop,\n          scrollHeight = _this$container.scrollHeight,\n          clientHeight = _this$container.clientHeight;\n\n      if (e.touches.length === 1 && scrollTop !== scrollHeight - clientHeight) {\n        // prevent propagating event to MediaModal\n        e.stopPropagation();\n        return;\n      }\n\n      if (e.touches.length !== 2) return;\n      e.preventDefault();\n      e.stopPropagation();\n      var distance = getDistance.apply(void 0, e.touches);\n      var midpoint = getMidpoint.apply(void 0, e.touches);\n\n      var _MAX_SCALE = Math.max(MAX_SCALE, _this.state.zoomMatrix.rate);\n\n      var scale = clamp(MIN_SCALE, _MAX_SCALE, _this.state.scale * distance / _this.lastDistance);\n\n      _this.zoom(scale, midpoint);\n\n      _this.lastMidpoint = midpoint;\n      _this.lastDistance = distance;\n    };\n\n    _this.handleClick = function (e) {\n      // don't propagate event to MediaModal\n      e.stopPropagation();\n      var dragged = _this.state.dragged;\n\n      _this.setState({\n        dragged: false\n      });\n\n      if (dragged) return;\n      var handler = _this.props.onClick;\n      if (handler) handler();\n\n      _this.setState({\n        navigationHidden: !_this.state.navigationHidden\n      });\n    };\n\n    _this.handleMouseDown = function (e) {\n      e.preventDefault();\n    };\n\n    _this.initZoomMatrix = function () {\n      var _this$props = _this.props,\n          width = _this$props.width,\n          height = _this$props.height;\n      var _this$container2 = _this.container,\n          clientWidth = _this$container2.clientWidth,\n          clientHeight = _this$container2.clientHeight;\n      var _this$image = _this.image,\n          offsetWidth = _this$image.offsetWidth,\n          offsetHeight = _this$image.offsetHeight;\n      var clientHeightFixed = clientHeight - NAV_BAR_HEIGHT;\n      var type = width / height < clientWidth / clientHeightFixed ? 'width' : 'height';\n      var fullScreen = type === 'width' ? width > clientWidth : height > clientHeightFixed;\n      var rate = type === 'width' ? Math.min(clientWidth, width) / offsetWidth : Math.min(clientHeightFixed, height) / offsetHeight;\n      var scrollTop = type === 'width' ? (clientHeight - offsetHeight) / 2 - NAV_BAR_HEIGHT : (clientHeightFixed - offsetHeight) / 2;\n      var scrollLeft = (clientWidth - offsetWidth) / 2;\n      var translateX = type === 'width' ? (width - offsetWidth) / (2 * rate) : 0;\n      var translateY = type === 'height' ? (height - offsetHeight) / (2 * rate) : 0;\n\n      _this.setState({\n        zoomMatrix: {\n          type: type,\n          fullScreen: fullScreen,\n          rate: rate,\n          clientWidth: clientWidth,\n          clientHeight: clientHeight,\n          offsetWidth: offsetWidth,\n          offsetHeight: offsetHeight,\n          clientHeightFixed: clientHeightFixed,\n          scrollTop: scrollTop,\n          scrollLeft: scrollLeft,\n          translateX: translateX,\n          translateY: translateY\n        }\n      });\n    };\n\n    _this.handleZoomClick = function (e) {\n      e.preventDefault();\n      e.stopPropagation();\n      var _this$state = _this.state,\n          scale = _this$state.scale,\n          zoomMatrix = _this$state.zoomMatrix;\n\n      if (scale >= zoomMatrix.rate) {\n        _this.setState({\n          scale: MIN_SCALE,\n          lockScroll: {\n            x: 0,\n            y: 0\n          },\n          lockTranslate: {\n            x: 0,\n            y: 0\n          }\n        }, function () {\n          _this.container.scrollLeft = 0;\n          _this.container.scrollTop = 0;\n        });\n      } else {\n        _this.setState({\n          scale: zoomMatrix.rate,\n          lockScroll: {\n            x: zoomMatrix.scrollLeft,\n            y: zoomMatrix.scrollTop\n          },\n          lockTranslate: {\n            x: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateX,\n            y: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateY\n          }\n        }, function () {\n          _this.container.scrollLeft = zoomMatrix.scrollLeft;\n          _this.container.scrollTop = zoomMatrix.scrollTop;\n        });\n      }\n\n      _this.container.style.cursor = 'grab';\n\n      _this.container.style.removeProperty('user-select');\n    };\n\n    _this.setContainerRef = function (c) {\n      _this.container = c;\n    };\n\n    _this.setImageRef = function (c) {\n      _this.image = c;\n    };\n\n    return _this;\n  }\n\n  var _proto = ZoomableImage.prototype;\n\n  _proto.componentDidMount = function componentDidMount() {\n    var _this2 = this;\n\n    var handler = this.handleTouchStart;\n    this.container.addEventListener('touchstart', handler);\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('touchstart', handler);\n    });\n    handler = this.handleTouchMove; // on Chrome 56+, touch event listeners will default to passive\n    // https://www.chromestatus.com/features/5093566007214080\n\n    this.container.addEventListener('touchmove', handler, {\n      passive: false\n    });\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('touchend', handler);\n    });\n    handler = this.mouseDownHandler;\n    this.container.addEventListener('mousedown', handler);\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('mousedown', handler);\n    });\n    handler = this.mouseWheelHandler;\n    this.container.addEventListener('wheel', handler);\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('wheel', handler);\n    }); // Old Chrome\n\n    this.container.addEventListener('mousewheel', handler);\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('mousewheel', handler);\n    }); // Old Firefox\n\n    this.container.addEventListener('DOMMouseScroll', handler);\n    this.removers.push(function () {\n      return _this2.container.removeEventListener('DOMMouseScroll', handler);\n    });\n    this.initZoomMatrix();\n  };\n\n  _proto.componentWillUnmount = function componentWillUnmount() {\n    this.removeEventListeners();\n  };\n\n  _proto.componentDidUpdate = function componentDidUpdate() {\n    this.setState({\n      zoomState: this.state.scale >= this.state.zoomMatrix.rate ? 'compress' : 'expand'\n    });\n\n    if (this.state.scale === MIN_SCALE) {\n      this.container.style.removeProperty('cursor');\n    }\n  };\n\n  _proto.UNSAFE_componentWillReceiveProps = function UNSAFE_componentWillReceiveProps() {\n    var _this3 = this;\n\n    // reset when slide to next image\n    if (this.props.zoomButtonHidden) {\n      this.setState({\n        scale: MIN_SCALE,\n        lockTranslate: {\n          x: 0,\n          y: 0\n        }\n      }, function () {\n        _this3.container.scrollLeft = 0;\n        _this3.container.scrollTop = 0;\n      });\n    }\n  };\n\n  _proto.removeEventListeners = function removeEventListeners() {\n    this.removers.forEach(function (listeners) {\n      return listeners();\n    });\n    this.removers = [];\n  };\n\n  _proto.zoom = function zoom(nextScale, midpoint) {\n    var _this4 = this;\n\n    var _this$state2 = this.state,\n        scale = _this$state2.scale,\n        zoomMatrix = _this$state2.zoomMatrix;\n    var _this$container3 = this.container,\n        scrollLeft = _this$container3.scrollLeft,\n        scrollTop = _this$container3.scrollTop; // math memo:\n    // x = (scrollLeft + midpoint.x) / scrollWidth\n    // x' = (nextScrollLeft + midpoint.x) / nextScrollWidth\n    // scrollWidth = clientWidth * scale\n    // scrollWidth' = clientWidth * nextScale\n    // Solve x = x' for nextScrollLeft\n\n    var nextScrollLeft = (scrollLeft + midpoint.x) * nextScale / scale - midpoint.x;\n    var nextScrollTop = (scrollTop + midpoint.y) * nextScale / scale - midpoint.y;\n    this.setState({\n      scale: nextScale\n    }, function () {\n      _this4.container.scrollLeft = nextScrollLeft;\n      _this4.container.scrollTop = nextScrollTop; // reset the translateX/Y constantly\n\n      if (nextScale < zoomMatrix.rate) {\n        _this4.setState({\n          lockTranslate: {\n            x: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateX * ((nextScale - MIN_SCALE) / (zoomMatrix.rate - MIN_SCALE)),\n            y: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateY * ((nextScale - MIN_SCALE) / (zoomMatrix.rate - MIN_SCALE))\n          }\n        });\n      }\n    });\n  };\n\n  _proto.render = function render() {\n    var _this$props2 = this.props,\n        alt = _this$props2.alt,\n        src = _this$props2.src,\n        width = _this$props2.width,\n        height = _this$props2.height,\n        intl = _this$props2.intl;\n    var _this$state3 = this.state,\n        scale = _this$state3.scale,\n        lockTranslate = _this$state3.lockTranslate;\n    var overflow = scale === MIN_SCALE ? 'hidden' : 'scroll';\n    var zoomButtonShouldHide = this.state.navigationHidden || this.props.zoomButtonHidden || this.state.zoomMatrix.rate <= MIN_SCALE ? 'media-modal__zoom-button--hidden' : '';\n    var zoomButtonTitle = this.state.zoomState === 'compress' ? intl.formatMessage(messages.compress) : intl.formatMessage(messages.expand);\n    return /*#__PURE__*/React.createElement(React.Fragment, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 413,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(IconButton, {\n      className: \"media-modal__zoom-button \" + zoomButtonShouldHide,\n      title: zoomButtonTitle,\n      icon: this.state.zoomState,\n      onClick: this.handleZoomClick,\n      size: 40,\n      style: {\n        fontSize: '30px'\n        /* Fontawesome's fa-compress fa-expand is larger than fa-close */\n\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 414,\n        columnNumber: 9\n      }\n    }), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"zoomable-image\",\n      ref: this.setContainerRef,\n      style: {\n        overflow\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 424,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(\"img\", {\n      role: \"presentation\",\n      ref: this.setImageRef,\n      alt: alt,\n      title: alt,\n      src: src,\n      width: width,\n      height: height,\n      style: {\n        transform: \"scale(\" + scale + \") translate(-\" + lockTranslate.x + \"px, -\" + lockTranslate.y + \"px)\",\n        transformOrigin: '0 0'\n      },\n      draggable: false,\n      onClick: this.handleClick,\n      onMouseDown: this.handleMouseDown,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 429,\n        columnNumber: 11\n      }\n    })));\n  };\n\n  return ZoomableImage;\n}(React.PureComponent), _class2.propTypes = {\n  alt: PropTypes.string,\n  src: PropTypes.string.isRequired,\n  width: PropTypes.number,\n  height: PropTypes.number,\n  onClick: PropTypes.func,\n  zoomButtonHidden: PropTypes.bool,\n  intl: PropTypes.object.isRequired\n}, _class2.defaultProps = {\n  alt: '',\n  width: null,\n  height: null\n}, _temp)) || _class;\n\nexport { ZoomableImage as default };","map":{"version":3,"sources":["/home/runner/Mastodon/live/app/javascript/mastodon/features/ui/components/zoomable_image.js"],"names":["React","PropTypes","IconButton","defineMessages","injectIntl","messages","compress","expand","MIN_SCALE","MAX_SCALE","NAV_BAR_HEIGHT","getMidpoint","p1","p2","x","clientX","y","clientY","getDistance","Math","sqrt","pow","clamp","min","max","value","normalizeWheel","event","PIXEL_STEP","LINE_HEIGHT","PAGE_HEIGHT","sX","sY","pX","pY","detail","wheelDelta","wheelDeltaY","wheelDeltaX","axis","HORIZONTAL_AXIS","deltaY","deltaX","deltaMode","spinX","spinY","pixelX","pixelY","ZoomableImage","state","scale","zoomMatrix","type","fullScreen","rate","clientWidth","clientHeight","offsetWidth","offsetHeight","clientHeightFixed","scrollTop","scrollLeft","translateX","translateY","zoomState","navigationHidden","dragPosition","top","left","dragged","lockScroll","lockTranslate","removers","container","image","lastTouchEndTime","lastDistance","mouseWheelHandler","e","preventDefault","mouseDownHandler","style","cursor","userSelect","setState","addEventListener","mouseMoveHandler","mouseUpHandler","dx","dy","removeProperty","removeEventListener","handleTouchStart","touches","length","handleTouchMove","scrollHeight","stopPropagation","distance","midpoint","_MAX_SCALE","zoom","lastMidpoint","handleClick","handler","props","onClick","handleMouseDown","initZoomMatrix","width","height","handleZoomClick","setContainerRef","c","setImageRef","componentDidMount","push","passive","componentWillUnmount","removeEventListeners","componentDidUpdate","UNSAFE_componentWillReceiveProps","zoomButtonHidden","forEach","listeners","nextScale","nextScrollLeft","nextScrollTop","render","alt","src","intl","overflow","zoomButtonShouldHide","zoomButtonTitle","formatMessage","fontSize","transform","transformOrigin","PureComponent","propTypes","string","isRequired","number","func","bool","object","defaultProps"],"mappings":"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","sourcesContent":["import React from 'react';\nimport PropTypes from 'prop-types';\nimport IconButton from 'mastodon/components/icon_button';\nimport { defineMessages, injectIntl } from 'react-intl';\n\nconst messages = defineMessages({\n  compress: { id: 'lightbox.compress', defaultMessage: 'Compress image view box' },\n  expand: { id: 'lightbox.expand', defaultMessage: 'Expand image view box' },\n});\n\nconst MIN_SCALE = 1;\nconst MAX_SCALE = 4;\nconst NAV_BAR_HEIGHT = 66;\n\nconst getMidpoint = (p1, p2) => ({\n  x: (p1.clientX + p2.clientX) / 2,\n  y: (p1.clientY + p2.clientY) / 2,\n});\n\nconst getDistance = (p1, p2) =>\n  Math.sqrt(Math.pow(p1.clientX - p2.clientX, 2) + Math.pow(p1.clientY - p2.clientY, 2));\n\nconst clamp = (min, max, value) => Math.min(max, Math.max(min, value));\n\n// Normalizing mousewheel speed across browsers\n// copy from: https://github.com/facebookarchive/fixed-data-table/blob/master/src/vendor_upstream/dom/normalizeWheel.js\nconst normalizeWheel = event => {\n  // Reasonable defaults\n  const PIXEL_STEP = 10;\n  const LINE_HEIGHT = 40;\n  const PAGE_HEIGHT = 800;\n\n  let sX = 0,\n    sY = 0, // spinX, spinY\n    pX = 0,\n    pY = 0; // pixelX, pixelY\n\n  // Legacy\n  if ('detail' in event) {\n    sY = event.detail;\n  }\n  if ('wheelDelta' in event) {\n    sY = -event.wheelDelta / 120;\n  }\n  if ('wheelDeltaY' in event) {\n    sY = -event.wheelDeltaY / 120;\n  }\n  if ('wheelDeltaX' in event) {\n    sX = -event.wheelDeltaX / 120;\n  }\n\n  // side scrolling on FF with DOMMouseScroll\n  if ('axis' in event && event.axis === event.HORIZONTAL_AXIS) {\n    sX = sY;\n    sY = 0;\n  }\n\n  pX = sX * PIXEL_STEP;\n  pY = sY * PIXEL_STEP;\n\n  if ('deltaY' in event) {\n    pY = event.deltaY;\n  }\n  if ('deltaX' in event) {\n    pX = event.deltaX;\n  }\n\n  if ((pX || pY) && event.deltaMode) {\n    if (event.deltaMode === 1) { // delta in LINE units\n      pX *= LINE_HEIGHT;\n      pY *= LINE_HEIGHT;\n    } else { // delta in PAGE units\n      pX *= PAGE_HEIGHT;\n      pY *= PAGE_HEIGHT;\n    }\n  }\n\n  // Fall-back if spin cannot be determined\n  if (pX && !sX) {\n    sX = (pX < 1) ? -1 : 1;\n  }\n  if (pY && !sY) {\n    sY = (pY < 1) ? -1 : 1;\n  }\n\n  return {\n    spinX: sX,\n    spinY: sY,\n    pixelX: pX,\n    pixelY: pY,\n  };\n};\n\nexport default @injectIntl\nclass ZoomableImage extends React.PureComponent {\n\n  static propTypes = {\n    alt: PropTypes.string,\n    src: PropTypes.string.isRequired,\n    width: PropTypes.number,\n    height: PropTypes.number,\n    onClick: PropTypes.func,\n    zoomButtonHidden: PropTypes.bool,\n    intl: PropTypes.object.isRequired,\n  }\n\n  static defaultProps = {\n    alt: '',\n    width: null,\n    height: null,\n  };\n\n  state = {\n    scale: MIN_SCALE,\n    zoomMatrix: {\n      type: null, // 'width' 'height'\n      fullScreen: null, // bool\n      rate: null, // full screen scale rate\n      clientWidth: null,\n      clientHeight: null,\n      offsetWidth: null,\n      offsetHeight: null,\n      clientHeightFixed: null,\n      scrollTop: null,\n      scrollLeft: null,\n      translateX: null,\n      translateY: null,\n    },\n    zoomState: 'expand', // 'expand' 'compress'\n    navigationHidden: false,\n    dragPosition: { top: 0, left: 0, x: 0, y: 0 },\n    dragged: false,\n    lockScroll: { x: 0, y: 0 },\n    lockTranslate: { x: 0, y: 0 },\n  }\n\n  removers = [];\n  container = null;\n  image = null;\n  lastTouchEndTime = 0;\n  lastDistance = 0;\n\n  componentDidMount () {\n    let handler = this.handleTouchStart;\n    this.container.addEventListener('touchstart', handler);\n    this.removers.push(() => this.container.removeEventListener('touchstart', handler));\n    handler = this.handleTouchMove;\n    // on Chrome 56+, touch event listeners will default to passive\n    // https://www.chromestatus.com/features/5093566007214080\n    this.container.addEventListener('touchmove', handler, { passive: false });\n    this.removers.push(() => this.container.removeEventListener('touchend', handler));\n\n    handler = this.mouseDownHandler;\n    this.container.addEventListener('mousedown', handler);\n    this.removers.push(() => this.container.removeEventListener('mousedown', handler));\n\n    handler = this.mouseWheelHandler;\n    this.container.addEventListener('wheel', handler);\n    this.removers.push(() => this.container.removeEventListener('wheel', handler));\n    // Old Chrome\n    this.container.addEventListener('mousewheel', handler);\n    this.removers.push(() => this.container.removeEventListener('mousewheel', handler));\n    // Old Firefox\n    this.container.addEventListener('DOMMouseScroll', handler);\n    this.removers.push(() => this.container.removeEventListener('DOMMouseScroll', handler));\n\n    this.initZoomMatrix();\n  }\n\n  componentWillUnmount () {\n    this.removeEventListeners();\n  }\n\n  componentDidUpdate () {\n    this.setState({ zoomState: this.state.scale >= this.state.zoomMatrix.rate ? 'compress' : 'expand' });\n\n    if (this.state.scale === MIN_SCALE) {\n      this.container.style.removeProperty('cursor');\n    }\n  }\n\n  UNSAFE_componentWillReceiveProps () {\n    // reset when slide to next image\n    if (this.props.zoomButtonHidden) {\n      this.setState({\n        scale: MIN_SCALE,\n        lockTranslate: { x: 0, y: 0 },\n      }, () => {\n        this.container.scrollLeft = 0;\n        this.container.scrollTop = 0;\n      });\n    }\n  }\n\n  removeEventListeners () {\n    this.removers.forEach(listeners => listeners());\n    this.removers = [];\n  }\n\n  mouseWheelHandler = e => {\n    e.preventDefault();\n\n    const event = normalizeWheel(e);\n\n    if (this.state.zoomMatrix.type === 'width') {\n      // full width, scroll vertical\n      this.container.scrollTop = Math.max(this.container.scrollTop + event.pixelY, this.state.lockScroll.y);\n    } else {\n      // full height, scroll horizontal\n      this.container.scrollLeft = Math.max(this.container.scrollLeft + event.pixelY, this.state.lockScroll.x);\n    }\n\n    // lock horizontal scroll\n    this.container.scrollLeft = Math.max(this.container.scrollLeft + event.pixelX, this.state.lockScroll.x);\n  }\n\n  mouseDownHandler = e => {\n    this.container.style.cursor = 'grabbing';\n    this.container.style.userSelect = 'none';\n\n    this.setState({ dragPosition: {\n      left: this.container.scrollLeft,\n      top: this.container.scrollTop,\n      // Get the current mouse position\n      x: e.clientX,\n      y: e.clientY,\n    } });\n\n    this.image.addEventListener('mousemove', this.mouseMoveHandler);\n    this.image.addEventListener('mouseup', this.mouseUpHandler);\n  }\n\n  mouseMoveHandler = e => {\n    const dx = e.clientX - this.state.dragPosition.x;\n    const dy = e.clientY - this.state.dragPosition.y;\n\n    this.container.scrollLeft = Math.max(this.state.dragPosition.left - dx, this.state.lockScroll.x);\n    this.container.scrollTop = Math.max(this.state.dragPosition.top - dy, this.state.lockScroll.y);\n\n    this.setState({ dragged: true });\n  }\n\n  mouseUpHandler = () => {\n    this.container.style.cursor = 'grab';\n    this.container.style.removeProperty('user-select');\n\n    this.image.removeEventListener('mousemove', this.mouseMoveHandler);\n    this.image.removeEventListener('mouseup', this.mouseUpHandler);\n  }\n\n  handleTouchStart = e => {\n    if (e.touches.length !== 2) return;\n\n    this.lastDistance = getDistance(...e.touches);\n  }\n\n  handleTouchMove = e => {\n    const { scrollTop, scrollHeight, clientHeight } = this.container;\n    if (e.touches.length === 1 && scrollTop !== scrollHeight - clientHeight) {\n      // prevent propagating event to MediaModal\n      e.stopPropagation();\n      return;\n    }\n    if (e.touches.length !== 2) return;\n\n    e.preventDefault();\n    e.stopPropagation();\n\n    const distance = getDistance(...e.touches);\n    const midpoint = getMidpoint(...e.touches);\n    const _MAX_SCALE = Math.max(MAX_SCALE, this.state.zoomMatrix.rate);\n    const scale = clamp(MIN_SCALE, _MAX_SCALE, this.state.scale * distance / this.lastDistance);\n\n    this.zoom(scale, midpoint);\n\n    this.lastMidpoint = midpoint;\n    this.lastDistance = distance;\n  }\n\n  zoom(nextScale, midpoint) {\n    const { scale, zoomMatrix } = this.state;\n    const { scrollLeft, scrollTop } = this.container;\n\n    // math memo:\n    // x = (scrollLeft + midpoint.x) / scrollWidth\n    // x' = (nextScrollLeft + midpoint.x) / nextScrollWidth\n    // scrollWidth = clientWidth * scale\n    // scrollWidth' = clientWidth * nextScale\n    // Solve x = x' for nextScrollLeft\n    const nextScrollLeft = (scrollLeft + midpoint.x) * nextScale / scale - midpoint.x;\n    const nextScrollTop = (scrollTop + midpoint.y) * nextScale / scale - midpoint.y;\n\n    this.setState({ scale: nextScale }, () => {\n      this.container.scrollLeft = nextScrollLeft;\n      this.container.scrollTop = nextScrollTop;\n      // reset the translateX/Y constantly\n      if (nextScale < zoomMatrix.rate) {\n        this.setState({\n          lockTranslate: {\n            x: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateX * ((nextScale - MIN_SCALE) / (zoomMatrix.rate - MIN_SCALE)),\n            y: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateY * ((nextScale - MIN_SCALE) / (zoomMatrix.rate - MIN_SCALE)),\n          },\n        });\n      }\n    });\n  }\n\n  handleClick = e => {\n    // don't propagate event to MediaModal\n    e.stopPropagation();\n    const dragged = this.state.dragged;\n    this.setState({ dragged: false });\n    if (dragged) return;\n    const handler = this.props.onClick;\n    if (handler) handler();\n    this.setState({ navigationHidden: !this.state.navigationHidden });\n  }\n\n  handleMouseDown = e => {\n    e.preventDefault();\n  }\n\n  initZoomMatrix = () => {\n    const { width, height } = this.props;\n    const { clientWidth, clientHeight } = this.container;\n    const { offsetWidth, offsetHeight } = this.image;\n    const clientHeightFixed = clientHeight - NAV_BAR_HEIGHT;\n\n    const type = width / height < clientWidth / clientHeightFixed ? 'width' : 'height';\n    const fullScreen = type === 'width' ?  width > clientWidth : height > clientHeightFixed;\n    const rate = type === 'width' ? Math.min(clientWidth, width) / offsetWidth : Math.min(clientHeightFixed, height) / offsetHeight;\n    const scrollTop = type === 'width' ?  (clientHeight - offsetHeight) / 2 - NAV_BAR_HEIGHT : (clientHeightFixed - offsetHeight) / 2;\n    const scrollLeft = (clientWidth - offsetWidth) / 2;\n    const translateX = type === 'width' ? (width - offsetWidth) / (2 * rate) : 0;\n    const translateY = type === 'height' ? (height - offsetHeight) / (2 * rate) : 0;\n\n    this.setState({\n      zoomMatrix: {\n        type: type,\n        fullScreen: fullScreen,\n        rate: rate,\n        clientWidth: clientWidth,\n        clientHeight: clientHeight,\n        offsetWidth: offsetWidth,\n        offsetHeight: offsetHeight,\n        clientHeightFixed: clientHeightFixed,\n        scrollTop: scrollTop,\n        scrollLeft: scrollLeft,\n        translateX: translateX,\n        translateY: translateY,\n      },\n    });\n  }\n\n  handleZoomClick = e => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const { scale, zoomMatrix } = this.state;\n\n    if ( scale >= zoomMatrix.rate ) {\n      this.setState({\n        scale: MIN_SCALE,\n        lockScroll: {\n          x: 0,\n          y: 0,\n        },\n        lockTranslate: {\n          x: 0,\n          y: 0,\n        },\n      }, () => {\n        this.container.scrollLeft = 0;\n        this.container.scrollTop = 0;\n      });\n    } else {\n      this.setState({\n        scale: zoomMatrix.rate,\n        lockScroll: {\n          x: zoomMatrix.scrollLeft,\n          y: zoomMatrix.scrollTop,\n        },\n        lockTranslate: {\n          x: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateX,\n          y: zoomMatrix.fullScreen ? 0 : zoomMatrix.translateY,\n        },\n      }, () => {\n        this.container.scrollLeft = zoomMatrix.scrollLeft;\n        this.container.scrollTop = zoomMatrix.scrollTop;\n      });\n    }\n\n    this.container.style.cursor = 'grab';\n    this.container.style.removeProperty('user-select');\n  }\n\n  setContainerRef = c => {\n    this.container = c;\n  }\n\n  setImageRef = c => {\n    this.image = c;\n  }\n\n  render () {\n    const { alt, src, width, height, intl } = this.props;\n    const { scale, lockTranslate } = this.state;\n    const overflow = scale === MIN_SCALE ? 'hidden' : 'scroll';\n    const zoomButtonShouldHide = this.state.navigationHidden || this.props.zoomButtonHidden || this.state.zoomMatrix.rate <= MIN_SCALE ? 'media-modal__zoom-button--hidden' : '';\n    const zoomButtonTitle = this.state.zoomState === 'compress' ? intl.formatMessage(messages.compress) : intl.formatMessage(messages.expand);\n\n    return (\n      <React.Fragment>\n        <IconButton\n          className={`media-modal__zoom-button ${zoomButtonShouldHide}`}\n          title={zoomButtonTitle}\n          icon={this.state.zoomState}\n          onClick={this.handleZoomClick}\n          size={40}\n          style={{\n            fontSize: '30px', /* Fontawesome's fa-compress fa-expand is larger than fa-close */\n          }}\n        />\n        <div\n          className='zoomable-image'\n          ref={this.setContainerRef}\n          style={{ overflow }}\n        >\n          <img\n            role='presentation'\n            ref={this.setImageRef}\n            alt={alt}\n            title={alt}\n            src={src}\n            width={width}\n            height={height}\n            style={{\n              transform: `scale(${scale}) translate(-${lockTranslate.x}px, -${lockTranslate.y}px)`,\n              transformOrigin: '0 0',\n            }}\n            draggable={false}\n            onClick={this.handleClick}\n            onMouseDown={this.handleMouseDown}\n          />\n        </div>\n      </React.Fragment>\n    );\n  }\n\n}\n"]},"metadata":{"react-intl":{"messages":[{"id":"lightbox.compress","defaultMessage":"Compress image view box"},{"id":"lightbox.expand","defaultMessage":"Expand image view box"}]}},"sourceType":"module"}